//ROKRAT Malware Campaign by APT 37
let sha256_iocs = dynamic([
  "3fa06c290c477c133ca58512c7852fc998632721f2dc3a0984f18fbe86451e18",
  "ccb6ca4cb385db50dad2e3b7c68a90ddee62398edb0fd41afdb793287cfbe8e6",
  "9eca7ab62e3ad40b79116ad713462e3ae4d9610345952e5dd279f0b481870d4f",
  "7ee4326c5d0e6a30c1a9bdec045d670758fa1b36477992d61b03cb270113b196",
  "e27467f7fdfa721e917384542ce10cc6108dfd78df14e23872cf8df916e0b8c6",
  "7d514021c472e6e17f587ed30555d3f120653e6c7f8dc25d2331514b92ffd7bc",
  "41d9b6d8cf0fff85bf35327d4b94db629cd9f754c487672911b7f701fe8c5539",
  "6a2d984ef3fa0de9b9feb5f558381201e6dff42ef5efe4867fb24e47c6a2aade",
  "bf7d5020dcd7777509b7b542255814cd61bfb1599d532dd2fdbb50de2ad70bc5",
  "90bf1f20f962d04f8ae3f936d0f9046da28a75fa2fb37f267ff0453f272c60a0",
  "ca56720610400d6da773ffa4cce5b2447d4a665087604c9c6e1c9e71c048ccfc"
]);
let domain_patterns = dynamic([
  "api.pcloud.com",
  "cloud-api.yandex.net",
  "dropboxapi.com"
]);
let process_matches =
DeviceProcessEvents
| where
    (tolower(FileName) in~ ("mspaint.exe")  and tolower(InitiatingProcessFileName) in~ ("cmd.exe","powershell.exe") and ProcessCommandLine !contains @"C:\Program Files\BGInfo\hostname.bgi")
    or
    (tolower(SHA256) in~ (sha256_iocs))
    or 
    (tolower(InitiatingProcessFileName) =~ "powershell.exe" and ProcessCommandLine matches regex @"ttf0.*\.dat");
// DNS request events (equivalent to DnsRequest)
let dns_matches =
DeviceNetworkEvents
| where
    (tolower(InitiatingProcessFileName) in~ ("mspaint.exe","notepad.exe")
      and isnotempty(RemoteUrl)
      and (
        RemoteUrl has "api.dropboxapi.com"
        or RemoteUrl has "dropboxapi.com"
        or RemoteUrl has "cloud-api.yandex.net"
      ));
let file_matches =
DeviceFileEvents
| where ActionType in ("FileCreated","FileModified","FileRenamed")
| where (tolower(InitiatingProcessFileName) =~ "rundll32.exe" and tolower(FileName) =~ "version1.0.tmp")
    or 
    (FileName endswith ".lnk" and FileSize >= 50000000);
union process_matches,dns_matches,file_matches
| project-reorder Timestamp, DeviceName, ActionType,FileName, FolderPath, SHA256,InitiatingProcessFileName, InitiatingProcessCommandLine,InitiatingProcessParentFileName,
          RemoteUrl, RemoteIP, RemotePort, ProcessId, InitiatingProcessId
| order by Timestamp desc

//https://www.genians.co.kr/en/blog/threat_intelligence/rokrat_shellcode_steganographic
